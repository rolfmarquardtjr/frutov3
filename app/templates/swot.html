{% extends "base.html" %}

{% block title %}Fruto.IA - Análise SWOT{% endblock %}

{% block content %}
<h1 class="mb-4">Análise SWOT - {{ idea.title }}</h1>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <button id="analyzeSwot" class="btn btn-primary me-2">
                <i class="fas fa-brain"></i> Analisar SWOT com IA
            </button>
            <button id="generateSwot" class="btn btn-warning me-2" data-idea-id="{{ idea.id }}">
                <i class="fas fa-sync-alt"></i> Gerar SWOT
            </button>
            <button class="btn btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#analysisHistoryContent" aria-expanded="false" aria-controls="analysisHistoryContent">
                <i class="fas fa-history"></i> Histórico de Análises
            </button>
        </div>
    </div>
</div>

<div class="collapse mb-4" id="analysisHistoryContent">
    <div class="card card-body">
        <h5 class="card-title">Histórico de Análises</h5>
        {% if analyses %}
            {% for analysis in analyses %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Análise de {{ analysis.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}</h6>
                    <p class="card-text">{{ analysis.content }}</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">Nenhuma análise realizada ainda.</p>
        {% endif %}
    </div>
</div>

<div id="loadingSpinner" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p>Analisando SWOT...</p>
</div>

<div id="analysisCard" class="card mt-4" style="display: none;">
    <div class="card-body">
        <h5 class="card-title">Análise SWOT</h5>
        <p id="analysisContent" class="card-text"></p>
        <p class="card-text"><small class="text-muted">Análise gerada em: <span id="analysisTimestamp"></span></small></p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h3 class="card-title text-white">Forças (Strengths)</h3>
            </div>
            <div class="card-body">
                <ul id="strengthsList" class="list-group swot-list" data-category="strength">
                    {% for item in swot.items.filter_by(category='strength') %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                        <span class="swot-item-content">{{ item.content }}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-item" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger remove-item" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                <div class="mt-3">
                    <input type="text" id="newStrength" class="form-control" placeholder="Nova força">
                    <button class="btn btn-primary mt-2 add-item" data-category="strength">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h3 class="card-title text-white">Fraquezas (Weaknesses)</h3>
            </div>
            <div class="card-body">
                <ul id="weaknessesList" class="list-group swot-list" data-category="weakness">
                    {% for item in swot.items.filter_by(category='weakness') %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                        <span class="swot-item-content">{{ item.content }}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-item" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger remove-item" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                <div class="mt-3">
                    <input type="text" id="newWeakness" class="form-control" placeholder="Nova fraqueza">
                    <button class="btn btn-primary mt-2 add-item" data-category="weakness">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h3 class="card-title text-white">Oportunidades (Opportunities)</h3>
            </div>
            <div class="card-body">
                <ul id="opportunitiesList" class="list-group swot-list" data-category="opportunity">
                    {% for item in swot.items.filter_by(category='opportunity') %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                        <span class="swot-item-content">{{ item.content }}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-item" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger remove-item" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                <div class="mt-3">
                    <input type="text" id="newOpportunity" class="form-control" placeholder="Nova oportunidade">
                    <button class="btn btn-primary mt-2 add-item" data-category="opportunity">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h3 class="card-title text-dark">Ameaças (Threats)</h3>
            </div>
            <div class="card-body">
                <ul id="threatsList" class="list-group swot-list" data-category="threat">
                    {% for item in swot.items.filter_by(category='threat') %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.id }}">
                        <span class="swot-item-content">{{ item.content }}</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary edit-item" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger remove-item" title="Remover">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                <div class="mt-3">
                    <input type="text" id="newThreat" class="form-control" placeholder="Nova ameaça">
                    <button class="btn btn-primary mt-2 add-item" data-category="threat">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="swotAnalysis" class="mt-4" style="display: none;" data-swot-id="{{ swot.id }}">
    <h3>Análise SWOT por IA</h3>
    <div id="swotAnalysisContent"></div>
</div>

<!-- Adicione este modal no final do conteúdo -->
<div class="modal fade" id="swotItemModal" tabindex="-1" aria-labelledby="swotItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="swotItemModalLabel">Adicionar/Editar Item SWOT</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="swotItemForm">
                    <div class="mb-3">
                        <label for="swotItemContent" class="form-label">Conteúdo do Item</label>
                        <textarea class="form-control" id="swotItemContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="swotItemCategory" class="form-label">Categoria</label>
                        <select class="form-select" id="swotItemCategory">
                            <option value="strength">Força</option>
                            <option value="weakness">Fraqueza</option>
                            <option value="opportunity">Oportunidade</option>
                            <option value="threat">Ameaça</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="saveSwotItemBtn">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação para gerar SWOT -->
<div class="modal fade" id="confirmGenerateModal" tabindex="-1" aria-labelledby="confirmGenerateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmGenerateModalLabel">Confirmar Geração de SWOT</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                </div>
                <p class="text-center">Tem certeza que deseja gerar a análise SWOT? Isso substituirá todos os itens existentes.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirmGenerateBtn">Gerar SWOT</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/swot.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateSwotBtn = document.getElementById('generateSwot');
    const confirmGenerateModal = new bootstrap.Modal(document.getElementById('confirmGenerateModal'));
    const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');

    if (generateSwotBtn) {
        generateSwotBtn.addEventListener('click', function(e) {
            e.preventDefault();
            confirmGenerateModal.show();
        });
    }

    if (confirmGenerateBtn) {
        confirmGenerateBtn.addEventListener('click', function() {
            const ideaId = generateSwotBtn.dataset.ideaId;
            confirmGenerateModal.hide();
            
            // Fazer uma requisição AJAX em vez de redirecionar
            $.ajax({
                url: `/generate_swot/${ideaId}`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                success: function(response) {
                    if (response.success) {
                        // Recarregar a página ou atualizar o conteúdo SWOT
                        location.reload();
                    } else {
                        alert('Erro ao gerar SWOT: ' + response.error);
                    }
                },
                error: function() {
                    alert('Erro ao gerar SWOT. Por favor, tente novamente.');
                }
            });
        });
    }
});

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}
</script>
{% endblock %}
